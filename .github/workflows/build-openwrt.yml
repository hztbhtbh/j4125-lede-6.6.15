name: x64æ‡’äººç‰ˆ

on:
  repository_dispatch:
    types: lx64
  workflow_dispatch:
  #schedule:
  #  - cron: 00 16 * * *

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  APT: bin/apt
  UPLOAD_RELEASE: true

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "å·²çŸ¥CPUå‹å·ï¼ˆé™åºï¼‰ï¼š7763,8370C,8272CL,8171M,E5ç³»åˆ—"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
        echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo -e "$(df -hT)"
    - name: æ¸…ç†ç³»ç»Ÿ
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true
    - name: æ­å»ºç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo -E apt-get -y full-upgrade
        sudo -E apt-get -y install $(cat $APT)
        sudo -E systemctl daemon-reload
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean
        sudo -E timedatectl set-timezone "Asia/Shanghai"
    - name: æ‹‰å–æºç 
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
    - name: ç¼“å­˜
      id: cache
      uses: stupidloud/cachewrtbuild@main
      with:
        skip_saving: 'true'
        ccache: 'true'
        mixkey: 'x64'
        prefix: '${{ github.workspace }}/openwrt'
    - name: è‡ªå®šä¹‰é…ç½®
      run: |
        cd openwrt
        wget --no-check-certificate https://ac.ch89.cn/diy.sh
        chmod u+x diy.sh && ./diy.sh
        sed -i 's#mirrors.cloud.tencent.com/lede#ipk.ch89.cn/x64/bin#g' package/lean/default-settings/files/zzz-default-settings
        sed -i 's/OpenWrt/Bin AutoBuild ${{ env.DATE1 }} @ OpenWrt/g' package/lean/default-settings/files/zzz-default-settings
        sed -i 's/IMG_PREFIX:=/IMG_PREFIX:=k$(LINUX_VERSION)-/g' include/image.mk
    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt
        wget --no-check-certificate -O .config https://ac.ch89.cn/lx64.config
        make defconfig
        make download -j16
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
    - name: ç¼–è¯‘
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$[`nproc`+1] || make -j1 V=s
        echo "compile=success" >> $GITHUB_ENV
    - name: æ£€æŸ¥å‰©ä½™ç©ºé—´
      if: always()
      run: | 
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo -e "$(df -hT)"
    - name: æ•´ç†ç¼–è¯‘æ–‡ä»¶
      if: env.compile == 'success'
      run: |
        bin1=openwrt/bin/targets/x86/64
        mkdir -p bin2 && cp -r $bin1/* bin2
        rm -rf $bin1/*.gz bin2/packages
        tar -zcvf bin.tar.gz openwrt/bin
        cp bin.tar.gz bin2
    - name: å‘å¸ƒrelease
      if: env.UPLOAD_RELEASE == 'true' && env.compile == 'success'
      uses: ncipollo/release-action@main
      with:
        name: ${{ env.DATE }} ğŸš€ x64æ‡’äººç‰ˆ | è‡ªåŠ¨ç¼–è¯‘
        allowUpdates: true
        removeArtifacts: true
        tag: 3lx64
        commit: master
        token: ${{ secrets.RELEASES_TOKEN }}
        body: |
          ${{ env.useVersionInfo }}
        artifacts: bin2/*
